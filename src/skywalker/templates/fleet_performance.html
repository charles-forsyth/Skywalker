<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GCP Fleet Performance Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #333; line-height: 1.5; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 5px; }
        .meta { color: #7f8c8d; font-size: 14px; margin-bottom: 30px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #fff; border: 1px solid #dee2e6; padding: 20px; border-radius: 6px; text-align: center; }
        .stat-val { display: block; font-size: 28px; font-weight: bold; color: #2980b9; }
        .stat-label { color: #7f8c8d; text-transform: uppercase; font-size: 12px; font-weight: 600; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; color: #2c3e50; position: sticky; top: 0; }
        tr:hover { background-color: #fdfdfe; }

        .progress-bar { width: 100px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 10px; }
        .progress-fill { height: 100%; }
        .bg-green { background-color: #2ecc71; }
        .bg-yellow { background-color: #f1c40f; }
        .bg-red { background-color: #e74c3c; }
        .bg-blue { background-color: #3498db; }
        .bg-purple { background-color: #9b59b6; }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fleet Performance Dashboard</h1>
        <div class="meta">
            <strong>Scope:</strong> {{ scoping_project }}<br>
            <strong>Scan Time:</strong> {{ scan_time }}<br>
            <strong>Total Instances:</strong> {{ data | length }}
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <span class="stat-val">{{ (data | map(attribute='cpu_percent') | sum / data | length) | round(1) if data else 0 }}%</span>
                <span class="stat-label">Avg Fleet CPU</span>
            </div>
            <div class="stat-card">
                {% set busy_vms = data | selectattr('cpu_percent', 'gt', 80) | list | length %}
                <span class="stat-val">{{ busy_vms }}</span>
                <span class="stat-label">Busy VMs (>80% CPU)</span>
            </div>
            <div class="stat-card">
                {% set gpu_vms = data | selectattr('gpu_utilization', 'defined') | list | length %}
                <span class="stat-val">{{ gpu_vms }}</span>
                <span class="stat-label">GPUs Tracked</span>
            </div>
        </div>

        <h2>Detailed Instance Performance</h2>
        <table>
            <thead>
                <tr>
                    <th>Project ID</th>
                    <th>Instance Name</th>
                    <th>Type</th>
                    <th>Zone</th>
                    <th>CPU Utilization</th>
                    <th>Memory Usage</th>
                    <th>GPU Utilization</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data | sort(attribute='cpu_percent', reverse=True) %}
                <tr>
                    <td><strong>{{ row.project_id }}</strong></td>
                    <td><code>{{ row.instance_name }}</code></td>
                    <td>{{ row.machine_type }}</td>
                    <td>{{ row.zone }}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill {% if row.cpu_percent > 80 %}bg-red{% elif row.cpu_percent > 40 %}bg-yellow{% else %}bg-green{% endif %}" 
                                 style="width: {{ row.cpu_percent }}%;"></div>
                        </div>
                        {{ row.cpu_percent | round(1) }}%
                    </td>
                    <td>
                        {% if row.memory_percent is defined %}
                        <div class="progress-bar">
                            <div class="progress-fill bg-blue" style="width: {{ row.memory_percent }}%;"></div>
                        </div>
                        {{ row.memory_percent | round(1) }}%
                        {% else %}
                        <span style="color: #ccc;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.gpu_utilization is defined %}
                        <div class="progress-bar">
                            <div class="progress-fill bg-purple" style="width: {{ row.gpu_utilization }}%;"></div>
                        </div>
                        {{ row.gpu_utilization | round(1) }}%
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>
